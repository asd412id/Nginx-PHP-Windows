#!/bin/bash
cd $(dirname "$0")

if [ "$1" == "start" ]
then
	n=${4:-5}
	((x=n-1))

	if [ $x -lt 0 ]
	then
		x=0;
	fi
	sblock="
	upstream backend{
		server 127.0.0.1:9000;
		keepalive_requests 300;
		least_conn;
	}
	server {
	  listen ${3:-80} default_server;
	  listen [::]:${3:-80} default_server;

	  index index.php index.html;
	  root ${2:-/html};

	  server_name ${5:-localhost};

	  location / {
		try_files \$uri \$uri/ /index.php?\$args;
	  }

	  client_max_body_size 128M;

	  location ~* \\.php\$ {
		try_files \$uri =404;
		fastcgi_split_path_info ^(.+\\.php)(/.+)\$;
		fastcgi_pass backend;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
		fastcgi_param PATH_INFO \$fastcgi_path_info;
		fastcgi_read_timeout 300s;
	  }
	}
	server {
	  listen 443 ssl;
	  listen [::]:443 ssl;
	  
	  ssl_certificate /ssl/ssl.crt/server.crt;
	  ssl_certificate_key /ssl/ssl.key/server.key;
	  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

	  index index.php index.html;
	  root ${2:-/html};

	  server_name ${5:-localhost};

	  location / {
		try_files \$uri \$uri/ /index.php?\$args;
	  }

	  client_max_body_size 128M;

	  location ~* \\.php\$ {
		try_files \$uri =404;
		fastcgi_split_path_info ^(.+\\.php)(/.+)\$;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
		fastcgi_param PATH_INFO \$fastcgi_path_info;
		fastcgi_read_timeout 300;
	  }
	}
	";
	
	echo $sblock > ./sites-enabled/default.conf
	./$1.bat $x
	echo "NginX Server started!"
elif [ "$1" == "stop" ]
then
	./$1.bat
	echo "NginX Server stopped!"
else
	echo "Usage: [start|stop] [root_directory|default: '/html'|<string>] [port|default: 80|<number>] [max_upstream_server|default: 5|<number>] [server_name|default: localhost|<string>]";
fi
